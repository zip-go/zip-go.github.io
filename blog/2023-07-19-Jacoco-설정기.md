---
slug: 1 
title: 집사의고민팀 Jacoco 적용기 
authors: 가비
tags: [backend, java, jacoco]
---

안녕하세요, 집사의고민팀 가비입니다.

코드 커버리지를 위해 Jacoco를 적용한 과정에 대해 정리하고자 글을 작성하게 되었습니다.

코드 커버리지는 소프트웨어의 테스트 케이스가 얼마나 충족되었는지를 나타내는 지표 중 하나입니다. 테스트를 진행하였을 때 ‘코드 자체가 얼마나 실행되었느냐’는 것이고, 이는 수치를 통해 확인할 수 있는데요, 
JVM 진영에서는 Jacoco를 통해 코드 커버리지를 체크할 수 있습니다. 뿐만 아니라 테스트 코드를 실행한 후, 그 커버리지 결과를 보기 좋도록 html이나 xml, csv같은 리포트 형태로 생성할 수도 있습니다.

1. Jacoco 플러그인 추가

Gradle 설정에 jacoco 플러그인을 추가하고, 버전 설정을 합니다. 저희 팀은 자바 17을 사용하기 때문에, 자바 17을 공식적으로 지원하는 0.8.8 버전을 적용하였습니다.
```java
// builld.gradle
plugins {
  id 'jacoco'
}

jacoco {
    toolVersion = "0.8.8"
}
```

2. Gradle task 추가

Jacoco의 Gradle 플러그인 중, **jacocoTestReport**와 **jacocoTestCoverageVerification** task를 이용하였습니다.

jacocoTestReport는 바이너리 형태의 커버리지 결과를 사람이 읽기 좋은 형태로 변환해줄 수 있는 task이고, jacocoTestCoverageVerification은 설정한 커버리지 기준을 만족하는지 검증할 수 있는 task입니다.

저희팀은 로컬에서 보기 쉽게, html 파일만을 변환하도록 하였고(추후 SonarQube를 적용한다면, xml 파일도 필요하겠죠?), 커버리지는 0.9 이상일 때만 빌드에 성공하도록 설정하였습니다. 그리고 DTO, Exception, MainApplication을 리포트 파일 및 커버리지 측정에서 제거하였습니다.

구체적인 내용은 주석으로 설명하겠습니다.

```java
tasks.named('test') {
    useJUnitPlatform()
    finalizedBy 'jacocoTestReport' // test task 실행 마지막에, jacocoTestReport를 실행하도록 설정
}

jacocoTestReport {
    reports {
        html.required = true // html 파일을 생성하도록 설정

        html.destination file("${buildDir}/jacoco/index.html") // 생성 경로 설정
    }

    afterEvaluate {
        classDirectories.setFrom(
                files(classDirectories.files.collect {
                    fileTree(dir: it, excludes: [ //  리포트 제외할 파일 설정
                            '**/*Application*',
                            '**/*Exception*',
                            '**/*Response*',
                            '**/*Request*'
                    ])
                })
        )
    }

    finalizedBy 'jacocoTestCoverageVerification' // task 실행 마지막 단계에 jacocoTestCoverageVerification을 실행하도록 설정
}

jacocoTestCoverageVerification {
    violationRules {
        rule {
            enabled = true // 해당 rule을 적용할 것입니다
            element = "CLASS" // 클래스 단위로

            limit { // 라인 커버리지 단위를 0.9 설정
                counter = 'LINE'
                value = 'COVEREDRATIO' 
                minimum = 0.9 
            }

            excludes = [ // 커버리지 측정에서 제외할 파일들
                    '*.*Application',
                    '*.*Exception',
                    '*.*Response',
                    '*.*Request'
            ]
        }
    }
}
```

3. 실행 결과

테스트 실행시, 커버리지가 임의로 설정한 값(90%)를 넘지 못하면 실패하게 됩니다.

![빌드 실패 결과](https://user-images.githubusercontent.com/73161212/254122146-f9de550d-f3b8-44cd-947b-1eff03a704b2.png)





References
- https://hudi.blog/dallog-jacoco/
- https://techblog.woowahan.com/2661/
- https://www.jacoco.org/jacoco/trunk/doc/changes.html